<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">

<dom-module id="papan-placeholderlobby">
  <template>
    <paper-input always-float-label label="Lobby name" id="lobbyName" value="{{name}}"></paper-input>
    Public: <paper-toggle-button id="public"></paper-toggle-button>
  </template>
  <script>
    'use strict'

    Polymer({
      is: 'papan-placeholderlobby',

      ready: function() {
        if (this.userid !== this.owner) {
          this._isowner = false
          this.$.public.disabled = true
          this.$.lobbyName.disabled = true
        } else {
          this._isowner = true
        }
        this.$.public.addEventListener('change', () => {
          if (this._isowner) channel.send('setPublic', {
            id: this.id,
            public: this.$.public.checked
          })
        })
      },

      _nameChange: function() {
        if (this._isowner) channel.send('setName', {
          id: this.id,
          name: this.name
        })
      },

      _publicChange: function() {
        this.$.public.checked = this.public
      },

      properties: {
        name: {
          type: String,
          observer: '_nameChange'
        },
        public: {
          type: Boolean,
          value: false,
          observer: '_publicChange'
        },
        userid: {
          type: String
        },
        owner: {
          type: String
        },
        _isowner: {
          type: Boolean,
          value: false
        }
      }
    })
  </script>
</dom-module>

<dom-module id="papan-placeholder">
  <template>
    <paper-button on-tap="_connectToLocalLobbyServer">Launch and connect to local lobby</paper-button>
    <paper-input always-float-label label="Lobby Server" value="{{lobbyServer}}"></paper-input>
    <paper-button on-tap="_connectToLobbyServer">Connect to lobby server {{lobbyServer}}</paper-button>
    <div>Connection status: [[_status]]</div>
    <div>Local server address: [[_myIP]]</div>
    <paper-button id="createLobby" disabled on-tap="_createLobby">Create lobby</paper-button>

    <paper-dialog id="errorMessage" modal>
      <div>[[_errorMessage]]</div>
      <paper-button dialog-confirm autofocus>Close</paper-button>
    </paper-dialog>

    <div id="lobbies"></div>
  </template>
  <script>
    'use strict'

    Polymer({
      is: 'papan-placeholder',

      properties: {
        lobbyServer: {
          type: String,
          value: 'localhost'
        },

        userInfo: {
          type: Object
        }
      },

      ready() {
        channel.send('getLobbyConnectionStatus')
        channel.on('subscribed', data => {
          this.userInfo = data.self
        })
        channel.on('error', data => {
          this._errorMessage = data.error.message
          this.$.errorMessage.open()
        })
        channel.on('lobbyConnectionStatus', data => {
          this._status = data.status
          this.$.createLobby.disabled = this._status !== 'CONNECTED'
        })
        channel.on('info', data => {
          const id = data.id
          let lobby
          let needsAdd = false
          if (!this.$[id]) {
            lobby = document.createElement('papan-placeholderlobby')
            lobby.setAttribute('id', id)
            lobby.owner = data.owner.id
            needsAdd = true
          } else {
            lobby = this.$[id]
          }
          lobby.name = data.name
          lobby.userid = this.userInfo.id
          lobby.public = data.public
          if (needsAdd) {
            this.$.lobbies.appendChild(lobby)
          }
        })
        channel.on('localServerIP', data => {
          this._myIP = data.ip
        })
      },

      _connectToLocalLobbyServer: function() {
        channel.send('connectToLobbyServer', { connectLocal: true })
      },

      _connectToLobbyServer: function() {
        channel.send('connectToLobbyServer', { lobbyServer: this.lobbyServer })
      },

      _createLobby: function() {
        channel.send('join')
      },
    })
  </script>
</dom-module>
