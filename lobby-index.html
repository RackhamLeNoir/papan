<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Papan</title>

    <style is="papan-style">
      html:not([style-scope]):not(.style-scope),body:not([style-scope]):not(.style-scope) {
        margin: 0;
          font-family: 'Roboto', 'Noto', sans-serif;
          -webkit-font-smoothing: antialiased;
          background: #f1f1f1;
      }

      .js-off {
        display: none;
      }
    </style>

    <script>
      Papan = {
        jsLoader: path => new Promise((resolve, reject) => {
          const js = document.createElement('script')
          js.onload = () => {
            console.log('Loaded ' + path)
            resolve()
          }
          js.src = path
          document.head.appendChild(js)
        }),

        cssLoader: path => new Promise((resolve, reject) => {
          const css = document.createElement('link')
          css.onload = () => {
            console.log('Loaded ' + path)
            resolve()
          }
          css.rel = 'stylesheet'
          css.type = 'text/css'
          css.href = path
          document.head.appendChild(css)
        }),

        importLoader: path => new Promise((resolve, reject) => {
          const element = document.createElement('link')
          element.onload = () => {
            console.log('Loaded ' + path)
            resolve()
          }
          element.rel = 'import'
          element.href = path
          document.head.appendChild(element)
        })
      }

      setTimeout(() => {
        console.log('Papan Loading...')

        Papan.cssLoader('node_modules/spinkit/css/spinners/3-wave.css')
        .then(() => Promise.all([
          Papan.jsLoader('node_modules/deep-diff/releases/deep-diff-0.3.4.min.js'),
          Papan.jsLoader('node_modules/event-emitter-es6/dist/event-emitter.min.js'),
          Papan.jsLoader('bower_components/webcomponentsjs/webcomponents-lite.js'),
          Papan.jsLoader('src/common/utils.js')
        ]))
        .then(() => Promise.all([
          Papan.jsLoader('src/client/channel.js')
        ]))
        .then(() => Promise.all([
          Papan.jsLoader('src/client/lobbyinterface.js'),
          Papan.jsLoader('src/client/webtorrent.js'),
          Papan.importLoader('template/mainwindow.html')
        ]))
        .then(() => Promise.all([
          new Promise((resolve, reject) => {
            if (global.channel.ready()) {
              console.log('Channel already live, not waiting')
              resolve()
            } else {
              console.log('Channel not yet live, waiting...')
              global.channel.onready = resolve
            }
          }),
          new Promise((resolve, reject) => {
            if (webtorrentReady) {
              console.log('Webtorrent already live, not waiting')
              resolve()
            } else {
              console.log('Webtorrent not yet live, waiting...')
              webtorrentOnReady = resolve
            }
          })
        ]))
        .then(() => {
          const main = document.createElement('papan-main-window')
          const loader = document.getElementById('mainloader')

          document.getElementById('body').removeChild(loader)
          document.getElementById('maindiv').appendChild(main)
          console.log('Papan Loaded.')
        })
      }, 0)
    </script>

    <noscript>
      <style is="papan-js-off">
        .js-on {
          display: hidden;
        }

        .js-off {
          display: inline;
        }
      </style>
    </noscript>
  </head>
  <body id="body">
    <div class="js-off">
      <h2>Very sorry, but JavaScript is absolutely required here.</h2>
    </div>
    <div class="sk-wave" id="mainloader">
      <div class="sk-rect sk-rect1"></div>
      <div class="sk-rect sk-rect2"></div>
      <div class="sk-rect sk-rect3"></div>
      <div class="sk-rect sk-rect4"></div>
      <div class="sk-rect sk-rect5"></div>
    </div>
    <div class="js-on" id="maindiv"></div>
  </body>
</html>
