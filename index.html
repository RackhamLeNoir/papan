<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Papan</title>
    <script src="node_modules/deep-diff/releases/deep-diff-0.3.4.min.js"></script>
    <script src="node_modules/socket.io-client/dist/socket.io.js"></script>
    <script src="src/common/utils.js"></script>
    <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <link rel="import" href="template/mainwindow.html">

    <style is="papan-style">
      html:not([style-scope]):not(.style-scope),body:not([style-scope]):not(.style-scope) {
        margin: 0;
          font-family: 'Roboto', 'Noto', sans-serif;
          -webkit-font-smoothing: antialiased;
          background: #f1f1f1;
      }

      .js-off {
        display: none;
      }
    </style>

    <script>
      'use strict'

      let channel
      if (PapanUtils.isElectron()) {
        const electron = require('electron')
        const ipc = electron.ipcRenderer
        class Channel {
          on(event, callback) {
            ipc.on(event, (event, data) => callback(data))
          }
          once(event, callback) {
            ipc.once(event, (event, data) => callback(data))
          }
          send(event, data) {
            ipc.send(event, data)
          }
        }
        channel = new Channel()
      } else {
        const socket = io()
        class Channel {
          constructor() {
            this.listeners = {}
            socket.on('message', data => {
              const event = data.event
              const listeners = this.listeners[event]
              if (listeners) {
                let toremove = []
                for (let index = 0; index < listeners.length; index++) {
                  listeners[index].callback(data.message)
                  if (listeners[index].once) {
                    toremove.unshift(index)
                  }
                }
                toremove.forEach(index => {
                  listeners.splice(index, 1)
                })
              }
            })
          }
          on(event, callback) {
            if (!this.listeners[event]) {
              this.listeners[event] = []
            }
            this.listeners[event].push({ callback: callback })
          }
          once(event, callback) {
            if (!this.listeners[event]) {
              this.listeners[event] = []
            }
            this.listeners[event].push({ callback: callback, once: true })
          }
          send(event, data) {
            socket.send({ event: event, message: data })
          }
        }

        channel = new Channel()
      }
    </script>

    <noscript>
      <style is="papan-js-off">
        .js-on {
          display: hidden;
        }

        .js-off {
          display: inline;
        }
      </style>
    </noscript>
  </head>
  <body>
    <div class="js-on">
      <papan-main-window></papan-main-window>
    </div>
    <div class="js-off">
      <h2>Very sorry, but JavaScript is absolutely required here.</h2>
    </div>
  </body>
</html>
